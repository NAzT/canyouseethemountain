<!DOCTYPE html>
<html>
	<head>
		<title>Can You See The Mountain: Doi Suthep</title>

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<link rel="stylesheet" href="leaflet/leaflet.css" />
		<link rel="stylesheet" href="style.css?v=2" />

		<link rel="icon" href="/favicon.ico" type="image/x-icon">
	</head>
	<body class="locale-th">

		<div id="title-project">
			<h1>Can you see the mountain?<span>Doi Suthep</span></h1>
		</div>

		<div id="map" class="hide"></div>

		<div class="splash">
			<img class="geo-spinner" src="/images/Preloader_1	.gif"/>
			<p>กำลังค้นหาตำแหน่งของคุณ</p>
		</div>

		<div class="location-error hide">
			<h1>ไม่สามารถระบุตำแหน่งของคุณได้</h1>
			<p>กรุณา Refresh หน้าเว็บไซต์อีกครั้ง</p>
		</div>

		<div class="content hide">
			<h1 class="question">วันนี้คุณมองเห็นดอยสุเทพไหม?</h1>

			<div class="buttons">
				<button type="button" class="btn btn-response btn-clear" onclick="sendVisibility(100)">
					ชัดเจน
				</button>
				<button type="button" class="btn btn-response btn-hazy" onclick="sendVisibility(50)">
					เห็นบ้าง
				</button>
				<button type="button" class="btn btn-response btn-terrible" onclick="sendVisibility(0)">
					ไม่เลย
				</button>
			</div>
		</div>

		<div class="response hide">
			<div class="air-quality hide">
					<div class="metric pm10 hide">
						<div class="label">pm10</div>
						<div class="value"></div>
						<div class="date"></div>
					</div>
					<div class="metric pm25 hide">
						<div class="label">pm2.5</div>
						<div class="value"></div>
						<div class="date"></div>
					</div>
			</div>
			<div class="social-buttons">
				<a class="btn btn-social btn-face" href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fcanyouseethemountain.com%2F">share</a>
				<a class="btn btn-social btn-tweet" href="https://twitter.com/intent/tweet?text=Can%20you%20see%20Doi%20Suthep%20today%3F&url=http%3A%2F%2Fcanyouseethemountain.com%2F&hashtags=cnxsmoke">tweet</a>
			</div>
			<p>ขอบคุณค่ะ</p>
		</div>

		<script src="js/lib.js"></script>

		<script>
			var map = L.map('map', {zoomControl: false, attributionControl: false});
			var ajax = require('ajax');
			var coords = {};

			L.Icon.Default.imagePath = '/leaflet/images';

			L.tileLayer('http://{s}.tiles.wmflabs.org/bw-mapnik/{z}/{x}/{y}.png', {
				maxZoom: 18,
				attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
			}).addTo(map);

			function sendVisibility(visibility){
				ajax({
					type: 'POST',
					url: '/checkins',
					dataType: 'json',
					data: {
						checkin: {
							coords: coords,
							timezone: (new Date().getTimezoneOffset() / 60) * -1,
							landmark_id: 1,
							visibility: visibility
						}
					},
					success: function(response) {
						var chiangMaiCenter = L.latLng(18.788218, 98.985872);
						displayAirQuality(response.air_quality);
						L.geoJson(response.visibility_layer, {style: styleFeature, clickable: false}).addTo(map);
						document.querySelector('.content').classList.add('hide');
						document.querySelector('.response').classList.remove('hide');
						document.querySelector('#map').classList.add('response-state');
						map.invalidateSize();
						map.setView(chiangMaiCenter, 12)
						setTimeout(function(){ map.panBy([0, adjustedLat('.response')]); }, 500);
					},
					error: function() {
						alert( "Error submitting your results" );
					},
				});
			}

			function styleFeature(feature) {
				return {
					weight: 0,
					opacity: 0,
					fillColor: 'hsla(' + feature.properties.visibility + ', 70%, 40%, '+ feature.properties.accuracy +')',
					fillOpacity: 0.4
				};
			}

			navigator.geolocation.getCurrentPosition(function(pos) {
				document.querySelector('#map').classList.remove('hide');
				var latLng = L.latLng(pos.coords.latitude, pos.coords.longitude);
				coords = pos.coords;
				map.setView(latLng, 14);
				L.marker(latLng).addTo(map);
				// L.circle(latLng, coords.accuracy / 2).addTo(map);
				document.querySelector('.splash').classList.add('hide');
				document.querySelector('.content').classList.remove('hide');
				map.panBy(centerAdjustment('.content'));
			},
			function(errors) {
				document.querySelector('body').classList.add('no-location');
				document.querySelector('.splash').classList.add('hide');
				document.querySelector('.location-error').classList.remove('hide');
				document.querySelector('#map').classList.add('hide');
			});

			function centerAdjustment(content) {
				if( isPortrait() ) { return [0, adjustedLat(content)]; }
				else { return [adjustedLng(content), 0]; }
			}

			function adjustedLng(content) {
				var mapWidth = document.querySelector('#map').clientWidth;
				var contentWidth = document.querySelector(content).clientWidth;
				return (mapWidth / 2) - ((mapWidth - contentWidth) / 2);
			}

			function adjustedLat(content) {
				var mapHeight = document.querySelector('#map').clientHeight;
				var contentHeight = document.querySelector(content).clientHeight;
				return (mapHeight / 2) - ((mapHeight - contentHeight) / 2);
			}

			function isPortrait() {
				// query needs to be kept in sync with css
				return window.matchMedia("not all and (min-device-width: 375px) and (max-device-height: 667px) and (orientation: landscape)").matches;
			}

			function displayAirQuality(aq) {
				if( aq.pm10 !== undefined ) { displayAQMetric('.pm10', aq.pm10); }
				if( aq.pm25 !== undefined ) { displayAQMetric('.pm25', aq.pm25); }
				if( aq.pm10 !== undefined || aq.pm25 !== undefined ) {
					document.querySelector('.air-quality').classList.remove('hide');
				}
			}

			function displayAQMetric(selector, data) {
				var container = document.querySelector(selector);
				//container.querySelector('.date')
				container.querySelector('.value').textContent = Math.round(parseFloat(data.value));
				container.classList.remove('hide');
				container.classList.add(selector === '.pm10' ? pm10Level(data.value) : pm25Level(data.value));
			}

			function pm25Level(value) {
				value = parseFloat(value);
				if( value <= 12.0  ) { return 'good'; }
				if( value <= 35.4  ) { return 'moderate'; }
				if( value <= 55.4  ) { return 'unhealthy-sensitive'; }
				if( value <= 150.4 ) { return 'unhealthy'; }
				if( value <= 250.4 ) { return 'very-unhealthy'; }
				return 'hazardous';
			}

			function pm10Level(value) {
				value = parseInt(value);
				if( value <= 54  ) { return 'good'; }
				if( value <= 154 ) { return 'moderate'; }
				if( value <= 254 ) { return 'unhealthy-sensitive'; }
				if( value <= 354 ) { return 'unhealthy'; }
				if( value <= 424 ) { return 'very-unhealthy'; }
				return 'unhealthy';
			}
		</script>
	</body>
</html>
